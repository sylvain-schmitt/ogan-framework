# üìö Explications D√©taill√©es - Ogan Framework

> Guide complet expliquant les concepts et composants du framework

## Table des Mati√®res

1. [Fichier cookies.txt](#fichier-cookiestxt)
2. [ORM (Object-Relational Mapping)](#orm-object-relational-mapping)
3. [Variables d'Environnement (.env)](#variables-denvironnement-env)
4. [Composer Autoload](#composer-autoload)

---

## Fichier cookies.txt

### Qu'est-ce que c'est ?

Le fichier `cookies.txt` est un fichier g√©n√©r√© automatiquement par certains outils (comme `curl` ou des extensions de navigateur) pour stocker les cookies HTTP dans un format standardis√©.

### Format du fichier

```
# Netscape HTTP Cookie File
# https://curl.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

localhost	FALSE	/	FALSE	0	PHPSESSID	pehu4kn5l92lhd3b630gr2trqt
```

**Structure d'une ligne :**
```
domain	flag	path	secure	expiration	name	value
```

- **domain** : Le domaine pour lequel le cookie est valide (`localhost`)
- **flag** : `TRUE` si le cookie est valide pour tous les sous-domaines, `FALSE` sinon
- **path** : Le chemin pour lequel le cookie est valide (`/`)
- **secure** : `TRUE` si le cookie ne doit √™tre envoy√© que via HTTPS, `FALSE` sinon
- **expiration** : Timestamp Unix de l'expiration (0 = session)
- **name** : Nom du cookie (`PHPSESSID`)
- **value** : Valeur du cookie (`pehu4kn5l92lhd3b630gr2trqt`)

### √Ä quoi √ßa sert ?

1. **Tests avec curl** : Permet de r√©utiliser les cookies d'une session pour faire des requ√™tes authentifi√©es
   ```bash
   curl -b cookies.txt http://localhost:8000/api/users
   ```

2. **Debugging** : Voir quels cookies sont stock√©s par l'application

3. **Import/Export** : Transf√©rer des sessions entre environnements

### Dois-je le versionner ?

**NON !** ‚ö†Ô∏è Ce fichier contient des donn√©es de session qui peuvent √™tre sensibles. Il est d√©j√† dans `.gitignore`.

### Dans Ogan Framework

Ce fichier n'est **pas utilis√©** par le framework lui-m√™me. C'est probablement un fichier g√©n√©r√© par :
- Une extension de navigateur (pour exporter les cookies)
- Un outil de test (Postman, Insomnia)
- Une commande `curl` avec l'option `-c cookies.txt`

Vous pouvez le supprimer sans probl√®me si vous n'en avez pas besoin.

---

## ORM (Object-Relational Mapping)

### Qu'est-ce qu'un ORM ?

Un ORM est un outil qui fait le pont entre le monde **relationnel** (base de donn√©es SQL) et le monde **objet** (PHP).

**Sans ORM :**
```php
// Code SQL brut
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([123]);
$user = $stmt->fetch(PDO::FETCH_ASSOC);
echo $user['name']; // Tableau associatif
```

**Avec ORM :**
```php
// Code orient√© objet
$user = User::find(123);
echo $user->name; // Objet avec propri√©t√©s
```

### Architecture de l'ORM Ogan

Notre ORM est compos√© de plusieurs couches :

#### 1. **Database** (`ogan/Database/Database.php`)
- **R√¥le** : Gestionnaire de connexion PDO
- **Pattern** : Singleton (une seule connexion pour toute l'app)
- **Fonctionnalit√©s** :
  - Connexion √† la base de donn√©es
  - Gestion des transactions
  - Configuration depuis Config/.env

**Exemple :**
```php
$pdo = Database::getConnection();
Database::beginTransaction();
// ... op√©rations ...
Database::commit();
```

#### 2. **QueryBuilder** (`ogan/Database/QueryBuilder.php`)
- **R√¥le** : Construction de requ√™tes SQL de mani√®re orient√©e objet
- **Avantages** :
  - S√©curit√© (requ√™tes pr√©par√©es)
  - Lisibilit√© (m√©thodes cha√Ænables)
  - Flexibilit√© (construit des requ√™tes complexes)

**Exemple :**
```php
$users = QueryBuilder::table('users')
    ->select(['id', 'name', 'email'])
    ->where('age', '>', 18)
    ->orderBy('name', 'ASC')
    ->limit(10)
    ->get();
```

**G√©n√®re :**
```sql
SELECT id, name, email FROM users WHERE age > ? ORDER BY name ASC LIMIT 10
```

#### 3. **Model** (`ogan/Database/Model.php`)
- **R√¥le** : Classe de base pour tous les mod√®les (Active Record Pattern)
- **Pattern** : Active Record (chaque instance = une ligne de la table)
- **Fonctionnalit√©s** :
  - CRUD automatique (Create, Read, Update, Delete)
  - Magic methods (`__get`, `__set`)
  - Hydratation automatique

**Exemple :**
```php
class User extends Model {
    protected static string $table = 'users';
}

// Cr√©er
$user = new User();
$user->name = 'Ogan';
$user->email = 'ogan@example.com';
$user->save(); // INSERT

// Lire
$user = User::find(1);
$users = User::where('age', '>', 18)->get();

// Mettre √† jour
$user->name = 'Ogan Updated';
$user->save(); // UPDATE

// Supprimer
$user->delete();
```

#### 4. **Repository** (`ogan/Database/AbstractRepository.php`)
- **R√¥le** : Pattern Repository (Data Mapper)
- **Avantages** :
  - S√©paration logique m√©tier / persistance
  - Testabilit√© (on peut cr√©er un FakeRepository)
  - Flexibilit√© (on peut changer de DB sans modifier les entit√©s)

**Exemple :**
```php
class UserRepository extends AbstractRepository {
    protected string $entityClass = User::class;
    protected string $table = 'users';
    
    public function findByEmail(string $email): ?User {
        return $this->findOneBy(['email' => $email]);
    }
}
```

### Types de Bases de Donn√©es Support√©es

#### ‚úÖ Support Multi-Bases de Donn√©es

L'ORM supporte **4 types de bases de donn√©es** :

1. **MySQL / MariaDB** (driver: `mysql` ou `mariadb`)
2. **PostgreSQL** (driver: `pgsql` ou `postgresql`)
3. **SQLite** (driver: `sqlite`)
4. **SQL Server** (driver: `sqlsrv` ou `mssql`)

#### Configuration

**Via `config/parameters.php` :**
```php
'database' => [
    'driver' => 'mysql',        // mysql, pgsql, sqlite, sqlsrv
    'host' => 'localhost',
    'port' => 3306,
    'name' => 'myapp',
    'user' => 'root',
    'password' => 'secret',
    'charset' => 'utf8mb4',    // Uniquement pour MySQL/MariaDB
]
```

**Via `.env` :**
```env
DB_DRIVER=mysql
DB_HOST=localhost
DB_PORT=3306
DB_NAME=myapp
DB_USER=root
DB_PASS=secret
DB_CHARSET=utf8mb4
```

**Pour SQLite :**
```php
'database' => [
    'driver' => 'sqlite',
    'name' => 'myapp.db',  // Cr√©√© automatiquement dans var/db/
]
```

**Note** : Le QueryBuilder g√©n√®re du SQL standard qui fonctionne avec la plupart des bases de donn√©es. Seules quelques diff√©rences de syntaxe peuvent n√©cessiter des ajustements (voir [Guide Bases de Donn√©es](databases.md) pour plus de d√©tails).

### Diff√©rences entre Active Record et Data Mapper

#### Active Record (Model)
- ‚úÖ Plus simple √† comprendre
- ‚úÖ Moins de code
- ‚úÖ Utilis√© par Laravel (Eloquent), Ruby on Rails
- ‚ùå Couplage entre entit√© et persistance

#### Data Mapper (Repository)
- ‚úÖ S√©paration claire des responsabilit√©s
- ‚úÖ Plus flexible
- ‚úÖ Plus testable
- ‚úÖ Utilis√© par Doctrine (Symfony), Hibernate (Java)
- ‚ùå Plus de code

**Dans Ogan Framework** : Les deux sont disponibles ! Vous pouvez utiliser :
- `Model` pour des cas simples (Active Record)
- `Repository` pour des cas complexes (Data Mapper)

### Exemple Complet d'Utilisation

```php
// 1. Cr√©er un mod√®le
class User extends Model {
    protected static string $table = 'users';
    protected static ?string $primaryKey = 'id';
}

// 2. Configuration (config/parameters.php ou .env)
return [
    'database' => [
        'host' => 'localhost',
        'port' => 3306,
        'name' => 'myapp',
        'user' => 'root',
        'password' => 'secret',
        'charset' => 'utf8mb4',
    ],
];

// 3. Utilisation
$user = new User();
$user->name = 'Ogan';
$user->email = 'ogan@example.com';
$user->save(); // INSERT INTO users (name, email) VALUES (?, ?)

$user = User::find(1); // SELECT * FROM users WHERE id = 1
$users = User::where('age', '>', 18)->get(); // SELECT * FROM users WHERE age > 18

$user->name = 'Ogan Updated';
$user->save(); // UPDATE users SET name = ? WHERE id = ?

$user->delete(); // DELETE FROM users WHERE id = ?
```

### S√©curit√©

L'ORM utilise **toujours des requ√™tes pr√©par√©es** pour √©viter les injections SQL :

```php
// ‚úÖ S√âCURIS√â (requ√™te pr√©par√©e)
User::where('email', '=', $email)->first();

// ‚ùå DANGEREUX (injection SQL possible)
// Ne JAMAIS faire √ßa !
$pdo->query("SELECT * FROM users WHERE email = '$email'");
```

---

## Variables d'Environnement (.env)

### ‚úÖ Le syst√®me .env est activ√© !

Le Kernel initialise automatiquement `Config` avec le support `.env` au d√©marrage.

### üìù Format du fichier .env

Cr√©ez un fichier `.env` √† la racine du projet :

```env
# Configuration d'environnement
APP_ENV=dev
APP_DEBUG=true

# Base de donn√©es
DB_HOST=localhost
DB_PORT=3306
DB_NAME=myapp
DB_USER=root
DB_PASS=
DB_CHARSET=utf8mb4
```

### üîÑ Convention de Nommage

Les variables d'environnement sont automatiquement converties :

| Variable .env | Acc√®s dans le code |
|---------------|-------------------|
| `APP_ENV` | `Config::get('app.env')` |
| `APP_DEBUG` | `Config::get('app.debug')` |
| `DB_HOST` | `Config::get('database.host')` |
| `DB_NAME` | `Config::get('database.name')` |
| `DB_USER` | `Config::get('database.user')` |
| `DB_PASS` | `Config::get('database.password')` |

**R√®gle :**
- `APP_*` ‚Üí `app.*`
- `DB_*` ‚Üí `database.*`
- Les underscores `_` deviennent des points `.`

### üìä Hi√©rarchie de Priorit√©

1. **Variables d'environnement (.env)** ‚Üí **PRIORIT√â MAXIMALE** ‚≠ê
2. Fichier PHP (`config/parameters.php`)
3. Valeurs par d√©faut

**Exemple :**
```php
// Si .env contient : DB_HOST=production.db
// Et parameters.php contient : 'database' => ['host' => 'localhost']
// Alors Config::get('database.host') retournera 'production.db'
```

### üíª Utilisation dans le Code

#### Dans les Contr√¥leurs

```php
use Ogan\Config\Config;

class UserController extends AbstractController
{
    public function index()
    {
        $env = Config::get('app.env'); // 'dev' ou 'prod'
        $debug = Config::get('app.debug', false);
        
        if ($debug) {
            // Mode debug activ√©
        }
    }
}
```

#### Dans Database

La classe `Database` utilise automatiquement Config :

```php
// Database.php lit automatiquement depuis .env
$host = Config::get('database.host', 'localhost');
$dbname = Config::get('database.name', '');
$username = Config::get('database.user', 'root');
$password = Config::get('database.password', '');
```

#### Dans le Kernel

Le Kernel initialise Config automatiquement :

```php
// Kernel.php (ligne 117)
\Ogan\Config\Config::init($configPath, $envPath);
```

### üéØ Exemple Complet

#### 1. Cr√©er le fichier .env

```env
APP_ENV=prod
APP_DEBUG=false

DB_HOST=production.example.com
DB_PORT=3306
DB_NAME=myapp_prod
DB_USER=prod_user
DB_PASS=secret_password
```

#### 2. Utiliser dans le code

```php
// R√©cup√©rer la configuration
$dbHost = Config::get('database.host'); // 'production.example.com'
$env = Config::get('app.env'); // 'prod'
$debug = Config::get('app.debug'); // false

// Utilisation dans Database
$pdo = Database::getConnection(); // Utilise automatiquement les valeurs du .env
```

### ‚ö†Ô∏è S√©curit√©

**IMPORTANT :**

1. **Ne JAMAIS commiter `.env` dans Git** ‚úÖ (d√©j√† dans `.gitignore`)
2. **Cr√©er un `.env.example`** avec des valeurs d'exemple (sans secrets)
3. **Utiliser des valeurs diff√©rentes** pour dev/prod
4. **Ne pas partager** le fichier `.env` publiquement

### üîç V√©rification

Pour v√©rifier que `.env` est bien charg√© :

```php
// Dans un contr√¥leur ou un script de test
echo Config::get('app.env'); // Devrait afficher la valeur du .env
echo Config::get('database.host'); // Devrait afficher DB_HOST du .env
```

---

## Composer Autoload

### D√©tection Automatique

Le framework d√©tecte automatiquement si Composer est install√© :

```php
// autoload.php
$composerAutoload = __DIR__ . '/vendor/autoload.php';

if (file_exists($composerAutoload)) {
    require $composerAutoload; // Utilise Composer
} else {
    // Utilise l'autoloader maison
}
```

### Configuration

Le `composer.json` est configur√© avec l'autoload PSR-4 :

```json
{
    "autoload": {
        "psr-4": {
            "Ogan\\": "ogan/",
            "App\\": "src/"
        }
    }
}
```

### Avantages

- ‚úÖ Plus rapide (autoload optimis√©)
- ‚úÖ Compatible avec les packages Composer
- ‚úÖ Standard PSR-4
- ‚úÖ Pr√™t pour la publication sur Packagist

---

**Note** : Ces explications sont d√©taill√©es dans le code source avec des commentaires p√©dagogiques. N'h√©sitez pas √† explorer les fichiers pour en savoir plus !

