<?php

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸŒ CORS MIDDLEWARE (Cross-Origin Resource Sharing)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * RÃ”LE :
 * ------
 * Ajoute les headers CORS nÃ©cessaires pour permettre aux applications
 * front-end (React, Vue, Angular...) hÃ©bergÃ©es sur un autre domaine
 * d'accÃ©der Ã  votre API.
 * 
 * PROBLÃˆME RÃ‰SOLU :
 * -----------------
 * Sans CORS, le navigateur bloque les requÃªtes AJAX entre diffÃ©rents domaines :
 * 
 * âŒ Front-end sur http://localhost:3000 (React)
 *    â†’ API sur http://localhost:8000 (PHP)
 *    â†’ BLOQUÃ‰ par le navigateur (CORS error)
 * 
 * âœ… Avec CorsMiddleware :
 *    â†’ Headers CORS ajoutÃ©s
 *    â†’ Navigateur autorise la requÃªte
 * 
 * HEADERS CORS :
 * --------------
 * - Access-Control-Allow-Origin : Domaines autorisÃ©s
 * - Access-Control-Allow-Methods : MÃ©thodes HTTP autorisÃ©es (GET, POST...)
 * - Access-Control-Allow-Headers : Headers autorisÃ©s
 * - Access-Control-Allow-Credentials : Autoriser les cookies
 * 
 * REQUÃŠTE PREFLIGHT :
 * -------------------
 * Pour certaines requÃªtes (POST avec JSON, headers customs...),
 * le navigateur envoie d'abord une requÃªte OPTIONS (preflight).
 * Le middleware doit rÃ©pondre Ã  cette requÃªte avec les bons headers.
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

namespace Ogan\Middleware\Examples;

use Ogan\Middleware\MiddlewareInterface;
use Ogan\Http\RequestInterface;
use Ogan\Http\ResponseInterface;
use Ogan\Http\Response;

class CorsMiddleware implements MiddlewareInterface
{
    /**
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * AJOUTER LES HEADERS CORS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * 
     * FLUX :
     * ------
     * 1. Si requÃªte OPTIONS (preflight) â†’ Retourne 200 avec headers CORS
     * 2. Sinon â†’ Continue vers le contrÃ´leur et ajoute les headers Ã  la rÃ©ponse
     * 
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */
    public function handle(RequestInterface $request, callable $next): ResponseInterface
    {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Ã‰TAPE 1 : GÃ©rer la requÃªte OPTIONS (Preflight)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Le navigateur envoie une requÃªte OPTIONS avant la vraie requÃªte
        // pour vÃ©rifier si le serveur accepte les requÃªtes CORS.
        if ($request->getMethod() === 'OPTIONS') {
            // Retourne immÃ©diatement avec les headers CORS
            // Sans appeler le contrÃ´leur
            return $this->createCorsResponse(new Response());
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Ã‰TAPE 2 : RequÃªte normale â†’ Appeler le contrÃ´leur
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $response = $next($request);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Ã‰TAPE 3 : Ajouter les headers CORS Ã  la rÃ©ponse
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        return $this->createCorsResponse($response);
    }

    /**
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * CRÃ‰ER UNE RÃ‰PONSE AVEC HEADERS CORS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * 
     * Ajoute tous les headers CORS nÃ©cessaires Ã  une rÃ©ponse.
     * 
     * @param ResponseInterface $response RÃ©ponse Ã  enrichir
     * @return ResponseInterface RÃ©ponse avec headers CORS
     * 
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */
    private function createCorsResponse(ResponseInterface $response): ResponseInterface
    {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Header 1 : Access-Control-Allow-Origin
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Domaines autorisÃ©s Ã  faire des requÃªtes
        // 
        // OPTIONS :
        // - '*' : Tous les domaines (âš ï¸  moins sÃ©curisÃ©)
        // - 'http://localhost:3000' : Un domaine spÃ©cifique (recommandÃ©)
        // - Dynamique : Lire depuis la requÃªte et valider
        $response->setHeader('Access-Control-Allow-Origin', '*');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Header 2 : Access-Control-Allow-Methods
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MÃ©thodes HTTP autorisÃ©es
        $response->setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Header 3 : Access-Control-Allow-Headers
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Headers que le client peut envoyer
        $response->setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Header 4 : Access-Control-Allow-Credentials
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Autoriser l'envoi de cookies
        // âš ï¸  Si true, Access-Control-Allow-Origin ne peut PAS Ãªtre '*'
        $response->setHeader('Access-Control-Allow-Credentials', 'true');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Header 5 : Access-Control-Max-Age
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // DurÃ©e de cache de la rÃ©ponse preflight (en secondes)
        // Ã‰vite au navigateur de refaire des OPTIONS Ã  chaque requÃªte
        $response->setHeader('Access-Control-Max-Age', '86400'); // 24 heures

        return $response;
    }
}

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“š NOTES PÃ‰DAGOGIQUES
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * QUAND UTILISER CE MIDDLEWARE ?
 * -------------------------------
 * - API REST consommÃ©e par un front-end (React, Vue, Angular)
 * - Application mobile qui appelle votre API
 * - Widgets embarquÃ©s sur d'autres sites
 * 
 * UTILISATION :
 * -------------
 * // Toutes les routes API
 * $router->group(['prefix' => '/api', 'middleware' => new CorsMiddleware()], function($api) {
 *     $api->get('/users', [ApiController::class, 'users']);
 *     $api->post('/users', [ApiController::class, 'create']);
 * });
 * 
 * // Ou globalement pour toute l'application
 * $router->middleware(new CorsMiddleware());
 * 
 * SÃ‰CURITÃ‰ - BONNES PRATIQUES :
 * ------------------------------
 * âš ï¸  NE PAS utiliser '*' en production !
 * 
 * Version sÃ©curisÃ©e :
 * ```php
 * private array $allowedOrigins = [
 *     'http://localhost:3000',
 *     'https://myapp.com'
 * ];
 * 
 * public function handle(...) {
 *     $origin = $request->getHeader('Origin');
 *     if (in_array($origin, $this->allowedOrigins)) {
 *         $response->setHeader('Access-Control-Allow-Origin', $origin);
 *     }
 * }
 * ```
 * 
 * REQUÃŠTE PREFLIGHT EXPLIQUÃ‰E :
 * ------------------------------
 * 1. Le navigateur dÃ©tecte une requÃªte "non-simple" (POST avec JSON par ex.)
 * 2. Il envoie d'abord OPTIONS au serveur
 * 3. Le serveur rÃ©pond avec les headers CORS
 * 4. Si OK, le navigateur envoie la vraie requÃªte (POST)
 * 5. Sinon, il bloque et affiche une erreur CORS
 * 
 * RequÃªte simple = GET/POST avec Content-Type: text/plain ou application/x-www-form-urlencoded
 * RequÃªte complexe = Tout le reste (JSON, headers customs, PUT, DELETE...)
 * 
 * DEBUG CORS :
 * ------------
 * En cas d'erreur CORS :
 * 1. Ouvrir la console du navigateur (F12)
 * 2. Regarder l'onglet Network
 * 3. VÃ©rifier la requÃªte OPTIONS
 * 4. S'assurer que les headers sont bien retournÃ©s
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
